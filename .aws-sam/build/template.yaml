AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Feature Flag Management System with Auth and Audit (SQS)
Parameters:
  ExistingJWTSecretArn:
    Type: String
    Description: ARN of the existing JWT secret in Secrets Manager (us-east-1)
  ExistingDdbTableArn:
    Type: String
  ExistingDdbTableName:
    Type: String
  ExistingAuditQueueArn:
    Type: String
  ExistingAuditQueueUrl:
    Type: String
Globals:
  Function:
    Runtime: python3.12
    Timeout: 30
    Architectures:
    - x86_64
    Environment:
      Variables:
        DDB_TABLE_NAME:
          Ref: ExistingDdbTableName
        AUDIT_QUEUE_URL:
          Ref: ExistingAuditQueueUrl
        JWT_SECRET_ARN:
          Ref: ExistingJWTSecretArn
        JWT_ALGORITHM: HS256
Resources:
  PythonDependenciesLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: feature-flag-python-deps
      ContentUri: PythonDependenciesLayer
      CompatibleRuntimes:
      - python3.12
      RetentionPolicy: Retain
    Metadata:
      BuildMethod: python3.12
      BuildProperties:
        PIP_DEPENDENCIES_FILE: requirements.txt
      SamResourceId: PythonDependenciesLayer
  FeatureFlagAPI:
    Type: AWS::Serverless::Api
    Properties:
      Name: FeatureFlagAPI
      StageName: Dev
      Cors:
        AllowMethods: '''GET,POST,PUT,DELETE,OPTIONS'''
        AllowHeaders: '''Content-Type,Authorization'''
        AllowOrigin: '''*'''
  FeatureFlagExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service: lambda.amazonaws.com
          Action: sts:AssumeRole
      ManagedPolicyArns:
      - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
      - PolicyName: FeatureFlagPolicy
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - dynamodb:BatchWriteItem
            - dynamodb:PutItem
            - dynamodb:GetItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
            - dynamodb:Query
            Resource:
              Ref: ExistingDdbTableArn
          - Effect: Allow
            Action:
            - sqs:SendMessage
            Resource:
              Ref: ExistingAuditQueueArn
          - Effect: Allow
            Action:
            - secretsmanager:GetSecretValue
            Resource:
              Ref: ExistingJWTSecretArn
          - Effect: Allow
            Action:
            - sqs:ReceiveMessage
            - sqs:DeleteMessage
            - sqs:GetQueueAttributes
            - sqs:ChangeMessageVisibility
            Resource:
              Ref: ExistingAuditQueueArn
  Signup:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: AuthSignup
      CodeUri: Signup
      Handler: handlers.auth.signup_handler.main.handler
      Role:
        Fn::GetAtt:
        - FeatureFlagExecutionRole
        - Arn
      Layers:
      - Ref: PythonDependenciesLayer
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Path: /auth/signup
            Method: post
            RestApiId:
              Ref: FeatureFlagAPI
    Metadata:
      SamResourceId: Signup
  Login:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: AuthLogin
      CodeUri: Login
      Handler: handlers.auth.login_handler.main.handler
      Role:
        Fn::GetAtt:
        - FeatureFlagExecutionRole
        - Arn
      Layers:
      - Ref: PythonDependenciesLayer
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Path: /auth/login
            Method: post
            RestApiId:
              Ref: FeatureFlagAPI
    Metadata:
      SamResourceId: Login
  CreateFeature:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: CreateFeature
      CodeUri: CreateFeature
      Handler: handlers.features.create_feature.main.create_feature_handler
      Role:
        Fn::GetAtt:
        - FeatureFlagExecutionRole
        - Arn
      Layers:
      - Ref: PythonDependenciesLayer
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Path: /features
            Method: post
            RestApiId:
              Ref: FeatureFlagAPI
    Metadata:
      SamResourceId: CreateFeature
  UpdateFeatureEnv:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: UpdateFeatureEnv
      CodeUri: UpdateFeatureEnv
      Handler: handlers.features.update_feature_env.main.update_feature_env_handler
      Role:
        Fn::GetAtt:
        - FeatureFlagExecutionRole
        - Arn
      Layers:
      - Ref: PythonDependenciesLayer
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Path: /features/{flag}/env/{env}
            Method: put
            RestApiId:
              Ref: FeatureFlagAPI
    Metadata:
      SamResourceId: UpdateFeatureEnv
  DeleteFeatureEnv:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: DeleteFeatureEnv
      CodeUri: DeleteFeatureEnv
      Handler: handlers.features.delete_feature_env.main.delete_feature_env_handler
      Role:
        Fn::GetAtt:
        - FeatureFlagExecutionRole
        - Arn
      Layers:
      - Ref: PythonDependenciesLayer
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Path: /features/{flag}/env/{env}
            Method: delete
            RestApiId:
              Ref: FeatureFlagAPI
    Metadata:
      SamResourceId: DeleteFeatureEnv
  DeleteFeature:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: DeleteFeature
      CodeUri: DeleteFeature
      Handler: handlers.features.delete_feature.main.delete_feature_handler
      Role:
        Fn::GetAtt:
        - FeatureFlagExecutionRole
        - Arn
      Layers:
      - Ref: PythonDependenciesLayer
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Path: /features/{flag}
            Method: delete
            RestApiId:
              Ref: FeatureFlagAPI
    Metadata:
      SamResourceId: DeleteFeature
  GetFeature:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: GetFeature
      CodeUri: GetFeature
      Handler: handlers.features.get_feature.main.get_feature_handler
      Role:
        Fn::GetAtt:
        - FeatureFlagExecutionRole
        - Arn
      Layers:
      - Ref: PythonDependenciesLayer
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Path: /features/{flag}
            Method: get
            RestApiId:
              Ref: FeatureFlagAPI
    Metadata:
      SamResourceId: GetFeature
  EvaluateFeature:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: EvaluateFeature
      CodeUri: EvaluateFeature
      Handler: handlers.evaluate.main.evaluate_feature_handler
      Role:
        Fn::GetAtt:
        - FeatureFlagExecutionRole
        - Arn
      Layers:
      - Ref: PythonDependenciesLayer
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Path: /features/evaluate
            Method: post
            RestApiId:
              Ref: FeatureFlagAPI
    Metadata:
      SamResourceId: EvaluateFeature
  GetAuditLogs:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: GetAuditLogs
      CodeUri: GetAuditLogs
      Handler: handlers.features.audit.get_audit.main.get_feature_audit_handler
      Role:
        Fn::GetAtt:
        - FeatureFlagExecutionRole
        - Arn
      Layers:
      - Ref: PythonDependenciesLayer
      Events:
        ApiEvent:
          Type: Api
          Properties:
            Path: /features/{flag}/audit
            Method: get
            RestApiId:
              Ref: FeatureFlagAPI
    Metadata:
      SamResourceId: GetAuditLogs
  AuditConsumer:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: AuditConsumer
      CodeUri: AuditConsumer
      Handler: handlers.features.audit.consumer.main.handler
      Role:
        Fn::GetAtt:
        - FeatureFlagExecutionRole
        - Arn
      Layers:
      - Ref: PythonDependenciesLayer
      Events:
        SQSEvent:
          Type: SQS
          Properties:
            Queue:
              Ref: ExistingAuditQueueArn
            BatchSize: 10
    Metadata:
      SamResourceId: AuditConsumer
Outputs:
  ApiUrl:
    Description: API Gateway base URL
    Value:
      Fn::Sub: https://${FeatureFlagAPI}.execute-api.${AWS::Region}.amazonaws.com/Dev
